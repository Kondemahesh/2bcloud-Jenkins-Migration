name: CI-CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:
  
jobs:
  preparation:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set execute permission for scripts
        run: chmod +x ./scripts/*.sh
      
      - name: Preparation
        run: |
          echo "Running preparation step..."
          # Equivalent to pipelineUtils.prepareRun()
          chmod +x ./scripts/prepareRun.sh
          ./scripts/prepareRun.sh

  jobA:
    runs-on: self-hosted
    needs: preparation
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run JobA
        run: |
          echo "Running JobA..."
          # Equivalent to pipelineUtils.runJob('JobA')
          ./scripts/prepareRun.sh JobA

  jobB:
    runs-on: self-hosted
    needs: preparation
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run JobB
        run: |
          echo "Running JobB..."
          ./scripts/prepareRun.sh JobB

  jobC:
    runs-on: self-hosted
    needs: preparation
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run JobC
        run: |
          echo "Running JobC..."
          ./scripts/prepareRun.sh JobC

  integration:
    runs-on: self-hosted
    needs: [jobA, jobB, jobC]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Integration
        run: |
          echo "Integrating results of JobA, JobB, JobC..."
          # Equivalent to pipelineUtils.integrateJobs(['JobA','JobB','JobC'])
          ./scripts/integrateJobs.sh JobA JobB JobC

  deploy:
    runs-on: self-hosted
    needs: integration
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy
        run: |
          echo "Deploying application..."
          # Equivalent to pipelineUtils.deploy()
          ./scripts/deploy.sh
